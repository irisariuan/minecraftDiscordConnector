generator client {
    provider = "prisma-client"
    output   = "../generated/prisma"
}

datasource db {
    provider = "postgresql"
}

model User {
    id           String        @id
    credits      Int           @default(0)
    permission   Int           @default(0)
    transactions Transaction[]
    permissions  Permission[]
    tickets      UserTicket[]
}

model Transaction {
    id           String      @id @default(uuid())
    amount       Int
    finalAmount  Int?
    ticketId     String?
    ticket       UserTicket? @relation(fields: [ticketId], references: [id], onDelete: Cascade, onUpdate: NoAction)
    beforeAmount Int
    afterAmount  Int
    reason       String?
    timestamp    DateTime    @default(now())
    userId       String
    serverId     Int?
    server       Server?     @relation(fields: [serverId], references: [id], onDelete: Cascade, onUpdate: NoAction)
    user         User        @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

    @@index([userId])
}

model Permission {
    userId     String  @id
    user       User    @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
    serverId   Int
    server     Server  @relation(fields: [serverId], references: [id], onDelete: Cascade, onUpdate: NoAction)
    permission Int
    force      Boolean @default(false)

    @@index([userId])
}

model Server {
    id           Int           @id @default(autoincrement())
    port         Int[]         @default([25565])
    path         String        @unique
    pluginPath   String        @unique
    apiPort      Int?
    loaderType   String
    modType      String
    version      String
    tag          String?
    transactions Transaction[]
    permissions  Permission[]
    plugins      Plugin[]
    settings     Setting[]
}

model Setting {
    serverId Int
    server   Server @relation(fields: [serverId], references: [id], onDelete: Cascade, onUpdate: NoAction)
    type     String
    name     String
    value    Int

    @@id([serverId, name, type])
}

model Plugin {
    id Int @unique @default(autoincrement())

    projectId String
    versionId String

    serverId Int
    server   Server @relation(fields: [serverId], references: [id], onDelete: Cascade, onUpdate: NoAction)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    filePath  String

    @@id([projectId, versionId, serverId])
}

model Ticket {
    id          Int          @id @default(autoincrement())
    type        String
    description String?
    name        String
    effect      String
    value       Float
    userTickets UserTicket[]
}

model UserTicket {
    id       String  @id @default(uuid())
    ticketId Int
    ticket   Ticket  @relation(fields: [ticketId], references: [id], onDelete: Cascade, onUpdate: NoAction)
    
    userId   String
    user     User    @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
    reason   String?

    available Boolean @default(true)
    maxUse    Int?    @default(1)

    history      TicketHistory[]
    transactions Transaction[]

    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    expiresAt DateTime?

    @@index([userId])
}

model TicketHistory {
    id        String     @id @default(uuid())
    ticketId  String
    ticket    UserTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade, onUpdate: NoAction)
    action    String
    reason    String?
    timestamp DateTime   @default(now())

    @@index([ticketId])
}
